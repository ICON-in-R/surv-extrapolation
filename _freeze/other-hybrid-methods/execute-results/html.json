{
  "hash": "145c36cc25ec83aef8ba34131b81fbea",
  "result": {
    "markdown": "---\ntitle: \"Other hybrid methods\"\nbibliography: references.bib\nformat:\n  html:\n    code-copy: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n# Gelber method\n\n## Background\n\nA method similar to that developed by LRIG involved fitting an appropriate model to the tail of the Kaplan Meier curve and using the estimated model combined with the Kaplan Meier to produce an estimate of total mean survival. [@Gelber1993] state that this method is of particular use when it is easier to fit an appropriate parametric model to the tail of a Kaplan Meier rather than to the Kaplan Meier as a whole. In the method proposed by [@Gelber1993] log-cumulative hazard probability plots are used to determine the appropriate parametric model and to determine the appropriate values for the point at which the parametric curve takes over from the Kaplan Meier. Both the Gelber method and the LRIG Exponential method are likely to be sensitive to the point at which the parametric model takes over from the Kaplan Meier, $s_0$, and therefore if either of these methods are used it is important to provide clear rationale for the switch point using statistical analysis.\n\n\n$$\n\\hat{S}(t) = \\hat{S}_{KM}(s_0) S^*(t)/S^*(s_0) \\mbox{ for } t > s_0\n$$ This formulation from the original paper takes a combined (product) survival of the Kaplan-Meier and parametric curve after time $s_0$. In the following we will estimate a single extrapolated curve instead for simplicity.\n\n\n## R Examples\n\nWe will use the `ovarian` data set from the `flexsurv` package. First, let us show how to get the KM and parametric fit using the total data set.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(flexsurv)\nlibrary(dplyr)\n\n# survival data\n\n# kaplan-meier before cut point\nfitg <- flexsurvreg(formula = Surv(futime, fustat) ~ 1, data = ovarian, dist = \"gompertz\")\n\nplot(fitg)\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nNow, let us pick an arbitrary cut point at time 100 and find the KM probability of survival at that time.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_km <- survfit(formula = Surv(futime, fustat) ~ 1, data = ovarian)\n\nt_cutpt <- 400\np_cutpt <- min(fit_km$surv[fit_km$time < t_cutpt])\n```\n:::\n\n\nWe wish to fit the parametric curve to the data after the cut point so remove the data before this time.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- mutate(ovarian, cutpt = futime < t_cutpt)\ndata <- split(data, f = data$cutpt)\n```\n:::\n\n\nand fit the curve, in this case a gompertz,\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitcp <- flexsurvreg(formula = Surv(futime - t_cutpt, fustat) ~ 1, data = data$`FALSE`, dist = \"gompertz\")\n```\n:::\n\n\nIt just remains to summarise the fitted curve and plot it with the KM.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsumm <- summary(fitcp, t = seq(0, 1200, 10))\n\nS_cp <- summ[[1]]$est[summ[[1]]$time == 400]\n\nplot(fit_km)\nlines(x = summ[[1]][[\"time\"]] + t_cutpt,\n      y = summ[[1]][[\"est\"]]*p_cutpt,\n      type = \"l\", col = \"red\", lwd = 2)\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nNotice that `p_cutpt` is the KM survival probability at the cut point $\\hat{S}_{KM}(s_0)$.\n\nFor convenience, we have written a package to do all of these steps called `gelber_hybrid_curve`.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"plot_transformed_km() function\"}\ngelber_hybrid_curve <- function(formula =  Surv(futime, fustat) ~ 1,\n                                data = ovarian,\n                                dist = \"weibull\",\n                                t_cutpt = 100, ...) {\n  \n  # kaplan-meier before cut point\n  fit_km <- survfit(formula = formula, data = data)\n  plot(fit_km, ...)\n  xylims <- par(\"usr\")\n  \n  data_cutpt <- fitcp <- summ <- list()\n  \n  for (i in seq_along(t_cutpt)) {\n    \n    # what is S_hat at cut point?\n    p_cutpt[i] <- min(fit_km$surv[fit_km$time < t_cutpt[i]])\n    \n    ucl_cutpt <- min(fit_km$upper[fit_km$time < t_cutpt[i]])\n    lcl_cutpt <- min(fit_km$lower[fit_km$time < t_cutpt[i]])\n    \n    u95_km <- ucl_cutpt[i] - p_cutpt\n    l95_km <- p_cutpt[i] - lcl_cutpt\n    \n    data_cutpt[[i]] <-\n      data |> \n      filter(futime >= t_cutpt[i]) |> \n      mutate(futime = futime - t_cutpt[i])\n    \n    # parametric curve after cut point\n    fitcp[[i]] <- flexsurvreg(formula = formula,\n                              data = data_cutpt[[i]],\n                              dist = dist)\n    \n    summ[[i]] <- summary(fitcp[[i]], t = seq(0, xylims[2], 10))\n    \n    lines(x = summ[[i]][[1]][[\"time\"]] + t_cutpt[i],\n          y = summ[[i]][[1]][[\"est\"]]*p_cutpt[i],\n          type = \"l\", col = \"red\", lwd = 2)\n    \n    if (length(t_cutpt) == 1) {\n      lines(x = summ[[i]][[1]][[\"time\"]] + t_cutpt[i],\n            y = pmax(0, summ[[i]][[1]][[\"lcl\"]]*p_cutpt[i] - l95_km),\n            type = \"l\", col = \"red\", lty = 2)\n      \n      lines(x = summ[[i]][[1]][[\"time\"]] + t_cutpt[i],\n            y = pmax(0, summ[[i]][[1]][[\"lcl\"]]*p_cutpt[i]),\n            type = \"l\", col = \"red\", lty = 3)\n      \n      lines(x = summ[[i]][[1]][[\"time\"]] + t_cutpt[i],\n            y = pmin(1, summ[[i]][[1]][[\"ucl\"]]*p_cutpt[i] + u95_km),\n            type = \"l\", col = \"red\", lty = 2)\n      \n      lines(x = summ[[i]][[1]][[\"time\"]] + t_cutpt[i],\n            y = pmin(1, summ[[i]][[1]][[\"ucl\"]]*p_cutpt[i]),\n            type = \"l\", col = \"red\", lty = 3)\n    }\n  }\n}\n```\n:::\n\n\nThis can be used to explore the effect of using different cut points and different distributions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngelber_hybrid_curve(t_cutpt = 400, dist = \"exp\")\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\ngelber_hybrid_curve(t_cutpt = 400, dist = \"lognormal\")\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\ngelber_hybrid_curve(t_cutpt = c(100, 400, 600), xlim = c(0, 2000))\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n\n```{.r .cell-code}\ngelber_hybrid_curve(t_cutpt = c(100, 400, 600), dist = \"lognormal\", xlim = c(0, 2000))\n```\n\n::: {.cell-output-display}\n![](other-hybrid-methods_files/figure-html/unnamed-chunk-7-4.png){width=672}\n:::\n:::\n",
    "supporting": [
      "other-hybrid-methods_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}